<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Results breakdown</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #18181c;
      --surface2: #222228;
      --border: #2e2e36;
      --text: #e4e4e7;
      --textMuted: #a1a1aa;
      --accent: #7c3aed;
      --accentDim: rgba(124, 58, 237, 0.15);
      --layer1: #06b6d4;
      --layer2: #10b981;
      --layer3: #f59e0b;
      --radius: 10px;
      --font: 'DM Sans', system-ui, sans-serif;
      --mono: 'JetBrains Mono', monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 15px;
      line-height: 1.5;
    }

    .logo-openshift {
      position: fixed;
      top: 0;
      right: max(2rem, calc(50vw - 600px + 2rem));
      width: 8.33vw;
      max-width: 134px;
      height: auto;
      z-index: 10;
      pointer-events: none;
    }

    .logo-openshift img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      object-position: top right;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0 0 0.5rem;
      letter-spacing: -0.02em;
    }

    .subtitle {
      color: var(--textMuted);
      margin-bottom: 2rem;
    }

    .loading, .error {
      padding: 2rem;
      text-align: center;
      color: var(--textMuted);
    }

    .error {
      color: #f87171;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .call-structure-viz {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .call-structure-viz h2 {
      font-size: 0.85rem;
      letter-spacing: 0.02em;
      color: var(--textMuted);
      margin: 0 0 1rem;
      font-weight: 600;
    }

    .call-structure-flow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .call-structure-layer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
    }

    .call-structure-layer .layer-title {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--textMuted);
    }

    .call-structure-pods {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
    }

    .pod-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 3.5rem;
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-family: var(--mono);
      border: 2px solid;
      background: var(--surface2);
    }

    .pod-icon .pod-version {
      font-weight: 600;
      line-height: 1.2;
    }

    .pod-icon .pod-ip {
      font-size: 0.65rem;
      opacity: 0.85;
      margin-top: 0.15rem;
    }

    .call-structure-layer.layer1 .pod-icon { border-color: var(--layer1); color: var(--layer1); }
    .call-structure-layer.layer2 .pod-icon { border-color: var(--layer2); color: var(--layer2); }
    .call-structure-layer.layer3 .pod-icon { border-color: var(--layer3); color: var(--layer3); }

    .call-structure-arrow {
      display: flex;
      align-items: center;
      color: var(--textMuted);
      font-size: 1.25rem;
      padding: 0 0.25rem;
      flex-shrink: 0;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
    }

    .card .label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--textMuted);
      margin-bottom: 0.35rem;
    }

    .card .value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: var(--mono);
    }

    .section {
      margin-bottom: 2.5rem;
    }

    .section h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 1rem;
      color: var(--text);
    }

    .layer-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    @media (max-width: 800px) {
      .layer-grid {
        grid-template-columns: 1fr;
      }
    }

    .layer-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .layer-card.layer1 { border-top: 3px solid var(--layer1); }
    .layer-card.layer2 { border-top: 3px solid var(--layer2); }
    .layer-card.layer3 { border-top: 3px solid var(--layer3); }

    .layer-card h3 {
      font-size: 0.9rem;
      margin: 0;
      padding: 0.75rem 1rem;
      background: var(--surface2);
      font-weight: 600;
    }

    .layer-card.layer1 h3 { color: var(--layer1); }
    .layer-card.layer2 h3 { color: var(--layer2); }
    .layer-card.layer3 h3 { color: var(--layer3); }

    .layer-stats {
      padding: 1rem;
    }

    .layer-stats h4 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--textMuted);
      margin: 0 0 0.5rem;
    }

    .layer-stats ul {
      list-style: none;
      padding: 0;
      margin: 0 0 1rem;
    }

    .layer-stats ul:last-child {
      margin-bottom: 0;
    }

    .layer-stats li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.35rem 0;
      font-size: 0.9rem;
    }

    .layer-stats .ip {
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--textMuted);
    }

    .layer-stats .count {
      font-weight: 600;
      font-family: var(--mono);
    }

    .version-ip-group {
      margin-bottom: 0.75rem;
    }

    .version-ip-group .version-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--textMuted);
      display: block;
      margin-bottom: 0.25rem;
    }

    .version-ip-group ul {
      list-style: none;
      padding: 0 0 0 0.75rem;
      margin: 0;
    }

    .layer-stats li.ip-by-version {
      padding: 0.2rem 0;
      font-size: 0.85rem;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: var(--surface2);
      font-weight: 600;
      color: var(--textMuted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: 0.6rem 1rem;
      border-top: 1px solid var(--border);
    }

    tr:hover td {
      background: var(--accentDim);
    }

    td.path-cell {
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--textMuted);
    }

    .path-id {
      font-family: var(--mono);
      color: var(--textMuted);
      width: 3rem;
    }

    .unique-list {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .unique-list li {
      font-family: var(--mono);
      font-size: 0.85rem;
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--border);
      color: var(--textMuted);
    }

    .unique-list li:last-child {
      border-bottom: none;
    }

    .drop-and-clear {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }

    .drop-zone {
      flex: 1;
      min-width: 200px;
      min-height: 100px;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 1.5rem;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }

    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--accent);
      background: var(--accentDim);
    }

    .drop-zone .prompt {
      color: var(--textMuted);
      font-size: 0.9rem;
    }

    .drop-zone .prompt strong {
      color: var(--text);
    }

    .drop-zone input[type="file"] {
      display: none;
    }

    .btn-clear {
      padding: 0.6rem 1.2rem;
      font-family: var(--font);
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .btn-clear:hover {
      background: #2a2a32;
      border-color: var(--textMuted);
    }

    .drop-and-clear.has-data .drop-zone {
      min-height: 60px;
      min-width: 180px;
    }
  </style>
</head>
<body>
  <div class="logo-openshift" aria-hidden="true">
    <img src="hat-alone.png" alt="Red Hat" />
  </div>
  <div class="container">
    <h1>Results breakdown</h1>
    <p class="subtitle">Request paths from results.txt — layer1 → layer2 → layer3</p>

    <div class="drop-and-clear" id="dropAndClear">
      <label class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept=".txt,text/plain" />
        <span class="prompt"><strong>Drop a results file here</strong> or click to choose</span>
      </label>
      <button type="button" class="btn-clear" id="btnClear" style="display: none;">Clear results</button>
    </div>

    <div id="loading" class="loading">Loading…</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="app" style="display: none;"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const LAYER_REGEX = /layer(\d+)\s*\(v(\d+)\)\s*\[([^\]]+)\]/g;

    function parseResults(content) {
      const lines = content.split('\n').map((l) => l.trim()).filter(Boolean);
      const requests = lines.map((line, index) => {
        const hops = [];
        let m;
        LAYER_REGEX.lastIndex = 0;
        while ((m = LAYER_REGEX.exec(line)) !== null) {
          hops.push({
            layer: 'layer' + m[1],
            version: 'v' + m[2],
            ip: m[3].trim(),
          });
        }
        const layer1 = hops[0] || null;
        const layer2 = hops[1] || null;
        const layer3 = hops[2] || null;
        const pathKey = hops.map((h) => h.layer + ':' + h.version + '@' + h.ip).join(' → ');
        return {
          id: index + 1,
          path: hops,
          layer1,
          layer2,
          layer3,
          pathKey,
        };
      });

      const versionCount = { layer1: {}, layer2: {}, layer3: {} };
      const ipCount = { layer1: {}, layer2: {}, layer3: {} };
      const ipByVersion = { layer1: {}, layer2: {}, layer3: {} };
      const uniquePaths = new Set();

      requests.forEach((req) => {
        uniquePaths.add(req.pathKey);
        [req.layer1, req.layer2, req.layer3].forEach((hop) => {
          if (!hop) return;
          const layer = hop.layer;
          versionCount[layer][hop.version] = (versionCount[layer][hop.version] || 0) + 1;
          ipCount[layer][hop.ip] = (ipCount[layer][hop.ip] || 0) + 1;
          if (!ipByVersion[layer][hop.version]) ipByVersion[layer][hop.version] = {};
          const vIps = ipByVersion[layer][hop.version];
          vIps[hop.ip] = (vIps[hop.ip] || 0) + 1;
        });
      });

      return {
        totalRequests: requests.length,
        uniquePaths: uniquePaths.size,
        requests,
        versionCount,
        ipCount,
        ipByVersion,
        uniquePathList: [...uniquePaths].sort(),
      };
    }

    async function loadFromServer() {
      const res = await fetch('/api/results');
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function renderSummary(data) {
      return `
        <div class="summary">
          <div class="card">
            <div class="label">Total requests</div>
            <div class="value">${data.totalRequests.toLocaleString()}</div>
          </div>
          <div class="card">
            <div class="label">Unique paths</div>
            <div class="value">${data.uniquePaths.toLocaleString()}</div>
          </div>
        </div>
      `;
    }

    function getPodsPerLayer(ipByVersion) {
      const layers = ['layer1', 'layer2', 'layer3'];
      const out = { layer1: [], layer2: [], layer3: [] };
      layers.forEach((layer) => {
        const byVer = ipByVersion[layer] || {};
        Object.keys(byVer).sort().forEach((version) => {
          const ips = Object.keys(byVer[version] || {}).sort();
          ips.forEach((ip) => out[layer].push({ version, ip }));
        });
      });
      return out;
    }

    function renderCallStructure(data) {
      const pods = getPodsPerLayer(data.ipByVersion || {});
      const layers = [
        { key: 'layer1', title: 'Layer 1' },
        { key: 'layer2', title: 'Layer 2' },
        { key: 'layer3', title: 'Layer 3' },
      ];
      const layerBlocks = layers.map(({ key, title }, i) => {
        const podList = (pods[key] || []).map(
          (p) => `<div class="pod-icon" title="${p.version} @ ${p.ip}"><span class="pod-version">${p.version}</span><span class="pod-ip">${p.ip}</span></div>`
        ).join('');
        const arrow = i < layers.length - 1 ? '<div class="call-structure-arrow" aria-hidden="true">→</div>' : '';
        return `<div class="call-structure-layer ${key}"><span class="layer-title">${title}</span><div class="call-structure-pods">${podList || '<span class="pod-ip">—</span>'}</div></div>${arrow}`;
      }).join('');
      return `
        <div class="call-structure-viz">
          <h2>Application calling structure</h2>
          <div class="call-structure-flow">
            ${layerBlocks}
          </div>
        </div>
      `;
    }

    function renderLayerCard(layerName, versionCount, ipByVersion) {
      const versions = Object.entries(versionCount || {}).sort((a, b) => b[1] - a[1]);
      const versionTotal = versions.reduce((sum, [, c]) => sum + c, 0);
      const versionIps = ipByVersion || {};
      return `
        <div class="layer-card ${layerName}">
          <h3>${layerName}</h3>
          <div class="layer-stats">
            <h4>Versions</h4>
            <ul>
              ${versions.map(([v, c]) => {
                const pct = versionTotal ? Math.round((c / versionTotal) * 100) : 0;
                return `<li><span>${v}</span><span class="count">${c} (${pct}%)</span></li>`;
              }).join('')}
            </ul>
            <h4>IPs by version</h4>
            ${versions.map(([v, c]) => {
              const ips = Object.entries(versionIps[v] || {}).sort((a, b) => b[1] - a[1]);
              if (ips.length === 0) return '';
              const ipList = ips.map(([ip, count]) => `<li class="ip-by-version"><span class="ip">${ip}</span><span class="count">${count}</span></li>`).join('');
              return `<div class="version-ip-group"><span class="version-label">${v}</span><ul>${ipList}</ul></div>`;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderLayerBreakdown(data) {
      return `
        <div class="section">
          <h2>By layer</h2>
          <div class="layer-grid">
            ${renderLayerCard('layer1', data.versionCount.layer1, data.ipByVersion.layer1)}
            ${renderLayerCard('layer2', data.versionCount.layer2, data.ipByVersion.layer2)}
            ${renderLayerCard('layer3', data.versionCount.layer3, data.ipByVersion.layer3)}
          </div>
        </div>
      `;
    }

    function renderTable(data) {
      const rows = data.requests.slice(0, 100).map((r) => `
        <tr>
          <td class="path-id">#${r.id}</td>
          <td class="path-cell">${r.pathKey}</td>
        </tr>
      `).join('');
      const more = data.requests.length > 100 ? `<tr><td colspan="2" style="color: var(--textMuted); padding: 1rem;">… and ${data.requests.length - 100} more</td></tr>` : '';
      return `
        <div class="section">
          <h2>Requests (first 100)</h2>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Path (layer:version@IP)</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                ${more}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderUniquePaths(data) {
      const items = data.uniquePathList.map((p) => `<li>${p}</li>`).join('');
      return `
        <div class="section">
          <h2>Unique paths (${data.uniquePathList.length})</h2>
          <ul class="unique-list">
            ${items}
          </ul>
        </div>
      `;
    }

    function render(data) {
      $('app').innerHTML =
        renderSummary(data) +
        renderCallStructure(data) +
        renderLayerBreakdown(data) +
        renderTable(data) +
        renderUniquePaths(data);
    }

    function showData(data) {
      $('loading').style.display = 'none';
      $('error').style.display = 'none';
      $('app').style.display = 'block';
      $('btnClear').style.display = 'block';
      $('dropAndClear').classList.add('has-data');
      $('dropZone').querySelector('.prompt').innerHTML = '<strong>Drop another file</strong> to replace';
      render(data);
    }

    function clearResults() {
      $('app').style.display = 'none';
      $('app').innerHTML = '';
      $('error').style.display = 'none';
      $('btnClear').style.display = 'none';
      $('dropAndClear').classList.remove('has-data');
      $('dropZone').querySelector('.prompt').innerHTML = '<strong>Drop a results file here</strong> or click to choose';
    }

    function handleFile(file) {
      if (!file || !file.type.match(/text\/plain/) && !file.name.endsWith('.txt')) {
        $('error').style.display = 'block';
        $('error').textContent = 'Please drop or select a text file (.txt).';
        return;
      }
      $('error').style.display = 'none';
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = parseResults(e.target.result);
          if (data.requests.length === 0) {
            $('error').style.display = 'block';
            $('error').textContent = 'No valid request lines found in the file.';
            return;
          }
          showData(data);
        } catch (err) {
          $('error').style.display = 'block';
          $('error').textContent = err.message || 'Failed to parse file';
        }
      };
      reader.readAsText(file);
    }

    const dropZone = $('dropZone');
    const fileInput = $('fileInput');
    const btnClear = $('btnClear');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) handleFile(file);
      fileInput.value = '';
    });
    btnClear.addEventListener('click', clearResults);

    loadFromServer()
      .then((data) => {
        $('loading').style.display = 'none';
        showData(data);
      })
      .catch(() => {
        $('loading').style.display = 'none';
        $('dropZone').querySelector('.prompt').innerHTML = '<strong>Drop a results file here</strong> or click to choose';
      });
  </script>
</body>
</html>
